#!/bin/sh
#
# This is a wrapper script to lay down some environment specific configuartion
# before the daemon starts. This can be useful for pulling environment
# variables into the application without requiring anything too terribly goofy
# in the nginx runtime

cat > /etc/nginx/vars.conf << EOF
  # THIS FILE IS AUTOGENERATED BY run-nginx
  # DO NOT EDIT

  set \$webapp ${WEBAPP_SERVICE_HOST:-dummy-host};
  set \$webapp_port ${WEBAPP_SERVICE_PORT:-80};

  set \$canary ${CANARY_SERVICE_HOST:-dummy-host};
  set \$canary_port ${CANARY_SERVICE_PORT:-80};
EOF


if [ -f /etc/letsencrypt/live/codevalet.io/cert.pem ]; then
  cat >> /etc/nginx/vars.conf << EOF
  ssl_certificate_key /etc/letsencrypt/live/codevalet.io/privkey.pem;
  ssl_certificate     /etc/letsencrypt/live/codevalet.io/fullchain.pem;
EOF
fi;

/usr/bin/generate-nginx-locations

cat /etc/nginx/monkeys.conf

if [ "$1" = "test" ]; then
  exec /usr/sbin/nginx -t;
else
  exec /usr/sbin/nginx -g "daemon off;";
fi;
