#!/usr/bin/env ruby

require 'erb'

locations = {}

ENV.each_pair do |key, val|
  next unless key.match /JENKINS_(\w+)_SERVICE_(\w+)/
  user = $1.downcase.to_sym
  env_type = $2

  locations[user] ||= {}

  if env_type == 'HOST'
    locations[user][:host] = val
  elsif env_type == 'PORT'
    locations[user][:port] = val
  end
end

File.open('/etc/nginx/monkeys.conf', 'w+') do |f|
  f.write(ERB.new(DATA.read).result)
end

__END__

## THIS FILE IS AUTOGENERATED BY generate-nginx-locations
# DO NOT EDIT
#
<% locations.each_pair do |name, data| %>

  location = /u/<%= name %>/ {
    return 301 $scheme://$server_name/u/<%= name %>/blue/pipelines;
  }
  location /u/<%= name %> {
    proxy_set_header Host $host;
    proxy_pass http://<%= data[:host] %>:<%= data[:port] %>;
  }
<% end %>
