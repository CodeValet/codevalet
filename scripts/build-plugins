#!/bin/bash

REPOS_DIR=$PWD/build/repos
BASE_DIR=$(realpath $(dirname $0))
BUILDER_CONTAINER="rtyler/codevalet-builder"

mkdir -p $REPOS_DIR
mkdir -p $BASE_DIR/plugins

declare -A PROCESSED

function cloneWithDependencies() {
  if [ ! ${PROCESSED[$1]} ]; then
    PROCESSED[$1]="$1"
    if [ ! -d $1 ];  then
        git clone --depth 1 git://github.com/jenkinsci/$1.git
    fi;

    for pom in $(find $1 -iname 'pom.xml' -type f); do
        (cd $(dirname $pom) && ${BASE_DIR}/plugins-from-pom 'pom.xml')
    done;

    for dep in $(find $1 -iname '.plugins.txt' -type f -exec cat {} \; | sort -u); do
        cloneWithDependencies "${dep}-plugin"
    done;
  fi;
}

pushd $REPOS_DIR

  for plugin in $(cat $BASE_DIR/../plugins.txt); do
    cloneWithDependencies $plugin
  done;

  set -e
  for d in *-plugin; do
      echo ">> Building $d"
      (cd  $d && \
      docker run --rm -ti -v $HOME/.m2:/root/.m2 \
      -v $PWD:/data -w /data ${BUILDER_CONTAINER} mvn install -DskipTests)
  done;
  set +e

  for hpi in $(find . -iname "*.hpi" | grep -v "test-classes" | grep -v "target/plugins/"); do
      cp $hpi ../plugins
  done;
popd
